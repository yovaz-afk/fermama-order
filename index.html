<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Заявки ФерМама</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.5; }
    .animate-fade-in { animation: fadeIn 0.25s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-slate-50/50 text-slate-950">
  <div id="app" class="min-h-screen max-w-lg mx-auto pb-48">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-30 px-4 py-4 border-b border-slate-100 flex justify-between items-center shadow-sm">
      <div class="flex items-center gap-2">
        <div class="bg-green-600 w-8 h-8 rounded-lg flex items-center justify-center text-white font-black shadow-lg shadow-green-100 text-sm">Ф</div>
        <h1 class="font-black text-slate-950 tracking-tight text-lg">Заявки ФерМама</h1>
      </div>

      <div class="flex items-center gap-3">
        <a id="priceLink"
           href="https://docs.google.com/spreadsheets/d/1wK59xFtKVVBO-2Grm4AhyPFOSnXP3roZ/export?format=xlsx&gid=1718068021"
           class="flex items-center gap-1 text-[10px] font-black text-green-700 bg-green-50 border border-green-200 px-3 py-2 rounded-full hover:bg-green-100 transition-all uppercase tracking-wider">
          <i data-lucide="download" class="w-3.5 h-3.5"></i> Прайс
        </a>

        <button id="resetBtn" class="text-slate-400 hover:text-red-500 transition-colors" title="Очистить форму">
          <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 py-6 space-y-6">

      <!-- Intro -->
      <section class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
        <p class="text-sm font-bold text-slate-800">
          Собрали мини-приложение для сбора заявок с актуальными ценами.
        </p>
        <p class="text-xs text-slate-500 mt-1">
          Заполняй форму ниже, добавляй товары и отправляй заявку в Telegram.
        </p>
      </section>

      <!-- Status Alert -->
      <div id="statusAlert" class="hidden animate-fade-in flex items-center gap-3 p-4 rounded-2xl border">
        <i id="statusIcon" class="w-5 h-5"></i>
        <span id="statusText" class="text-sm font-black"></span>
      </div>

      <!-- Client Info -->
      <section class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
        <div class="space-y-1">
          <label class="text-[10px] text-slate-600 font-black uppercase flex items-center gap-1 tracking-wider">
            <i data-lucide="user" class="w-3 h-3 text-green-600"></i> Менеджер
          </label>
          <div class="relative">
            <select id="managerSelect"
                    class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3.5 text-sm font-black text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500/20 transition-all cursor-pointer">
              <option value="" disabled selected hidden>Выберите менеджера...</option>
            </select>
            <i data-lucide="chevron-down" class="absolute right-4 top-4 text-slate-400 pointer-events-none w-4 h-4"></i>
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-[10px] text-slate-600 font-black uppercase flex items-center gap-1 tracking-wider">
            <i data-lucide="store" class="w-3 h-3 text-green-600"></i> Клиент
          </label>
          <input type="text" id="clientInput" placeholder="Название магазина / ФИО"
                 class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3.5 text-sm font-black text-slate-950 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500/20 transition-all">
        </div>

        <div class="space-y-1">
          <label class="text-[10px] text-slate-600 font-black uppercase flex items-center gap-1 tracking-wider">
            <i data-lucide="calendar" class="w-3 h-3 text-green-600"></i> Дата приёма
          </label>
          <input type="date" id="dateInput"
                 class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3.5 text-sm font-black text-slate-950 focus:outline-none focus:ring-2 focus:ring-green-500/20 transition-all">
        </div>
      </section>

      <!-- Items -->
      <section class="space-y-3">
        <div class="flex items-center justify-between px-1">
          <h3 class="font-black text-slate-950 text-sm tracking-tight uppercase">Состав заявки</h3>
          <span id="itemsCount" class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full font-black">0 ПОЗ.</span>
        </div>

        <div id="itemsContainer" class="space-y-3"></div>

        <button id="addRowBtn"
                class="w-full flex items-center justify-center gap-2 py-4 bg-white border-2 border-dashed border-green-300 rounded-2xl text-green-700 font-black text-sm hover:bg-green-50 transition-all active:scale-[0.98] shadow-sm">
          <i data-lucide="plus" class="w-5 h-5"></i> Добавить товар
        </button>
      </section>

      <!-- Comment -->
      <section class="space-y-1">
        <label class="text-[10px] text-slate-600 font-black uppercase flex items-center gap-1 tracking-wider px-1">
          <i data-lucide="message-square" class="w-3 h-3 text-green-600"></i> Комментарий
        </label>
        <textarea id="commentInput" placeholder="Дополнительная информация к заказу..."
                  class="w-full min-h-[100px] bg-white border border-slate-200 rounded-3xl px-4 py-3 text-sm font-bold text-slate-950 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500/20 transition-all shadow-sm resize-none"></textarea>

        <div class="mt-2 text-xs text-slate-500">
          Отправка идёт через “Поделиться…” (без бота). Если Telegram не открылся — нажми “Копировать” и вставь вручную.
        </div>

        <!-- very short mini-instruction for TP -->
        <div class="mt-3 bg-slate-50 border border-slate-100 rounded-2xl p-4">
          <div class="text-[11px] font-black uppercase text-slate-700 tracking-wider">Мини-инструкция</div>
          <ol class="mt-2 text-sm font-bold text-slate-700 space-y-1 list-decimal list-inside">
            <li>Выбери <b>Менеджера</b>.</li>
            <li>Введи <b>Клиента</b>.</li>
            <li>Проверь <b>Дату приёма</b>.</li>
            <li>Нажми <b>Добавить товар</b> → выбери товар → введи количество (шт/кг).</li>
            <li>Добавь комментарий (если нужно).</li>
            <li>Нажми <b>ОТПРАВИТЬ</b> или <b>Копировать</b>.</li>
          </ol>
        </div>

        <!-- add-to-home-screen short -->
        <div class="mt-3 bg-white border border-slate-100 rounded-2xl p-4">
          <div class="text-[11px] font-black uppercase text-slate-700 tracking-wider">Добавить иконку на главный экран</div>
          <div class="mt-2 text-sm font-bold text-slate-700">
            В браузере телефона: <b>⋮ / Поделиться</b> → <b>“На главный экран”</b> → <b>Добавить</b>.
          </div>
        </div>
      </section>

    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-white/95 backdrop-blur-md border-t border-slate-100 p-4 shadow-[0_-10px_40px_rgba(0,0,0,0.06)] z-40 rounded-t-[2.5rem]">
      <div class="flex items-center justify-between mb-4 px-2">
        <span class="text-slate-500 font-black uppercase text-[10px] tracking-widest">Итого к оплате</span>
        <span class="text-2xl font-black text-slate-950">
          <span id="totalSum">0</span> <span class="text-lg font-bold text-green-600">₽</span>
        </span>
      </div>

      <div class="flex gap-2">
        <button id="copyBtn"
                class="flex-1 h-14 rounded-2xl flex items-center justify-center gap-2 bg-slate-100 text-slate-700 font-black hover:bg-slate-200 transition-all active:scale-95"
                title="Копировать">
          <i data-lucide="copy" class="w-5 h-5"></i>
        </button>

        <button id="sendBtn"
                class="flex-[3] h-14 rounded-2xl flex items-center justify-center gap-3 text-white font-black text-lg bg-[#24A1DE] hover:bg-[#1e8dbf] shadow-xl shadow-blue-100 transition-all active:scale-95">
          ОТПРАВИТЬ <i data-lucide="send" class="w-5 h-5"></i>
        </button>
      </div>
    </footer>
  </div>

  <script>
    // ======================
    // DATA
    // ======================

    const MANAGERS = [
      { name: "Наталья Йошкар-Ола" },
      { name: "Мария Чебоксары" }
    ];

    // ВАЖНО: тут НЕТ слова "ФерМама" в названиях (как ты просил)
    const PRODUCTS = [
      // 6.1 Штучные (шт)
      { id:"p1",  name:"Вареники с картошкой 450 гр", unit:"шт", price:145 },
      { id:"p2",  name:"Вареники с картошкой 900 гр", unit:"шт", price:290 },
      { id:"p3",  name:"Голубцы ленивые 500г", unit:"шт", price:220 },
      { id:"p4",  name:"Зразы Любительские 500 гр", unit:"шт", price:225 },
      { id:"p5",  name:"Котлеты Домашние 500 гр", unit:"шт", price:265 },
      { id:"p6",  name:"Котлеты По-киевски 500 гр", unit:"шт", price:240 },
      { id:"p7",  name:"Котлеты Пожарские 500 гр", unit:"шт", price:230 },
      { id:"p8",  name:"Котлеты Фирменные 500 гр", unit:"шт", price:268 },
      { id:"p9",  name:"Котлеты из индейки 500 г", unit:"шт", price:300 },
      { id:"p10", name:"Котлеты куриные с сырно-сливочной начинкой 500 гр", unit:"шт", price:258 },
      { id:"p11", name:"Манты по-сибирски 450 гр", unit:"шт", price:185 },
      { id:"p12", name:"Манты по-сибирски 900 гр", unit:"шт", price:370 },
      { id:"p13", name:"Наггетсы Фирменные 500 гр", unit:"шт", price:255 },
      { id:"p14", name:"Пельмени Домашние 450 гр", unit:"шт", price:179 },
      { id:"p15", name:"Пельмени Домашние 900 гр", unit:"шт", price:358 },
      { id:"p16", name:"Пельмени Куриные 450 гр", unit:"шт", price:159 },
      { id:"p17", name:"Пельмени Куриные 900 гр", unit:"шт", price:318 },
      { id:"p18", name:"Пельмени Свинина-Курица 450 гр", unit:"шт", price:160 },
      { id:"p19", name:"Пельмени Свинина-Курица 900 гр", unit:"шт", price:320 },
      { id:"p20", name:"Пельмени из свинины 450г", unit:"шт", price:161 },
      { id:"p21", name:"Пельмени из свинины 900g", unit:"шт", price:322 },
      { id:"p22", name:"Пельмени из филе грудки индейки со слив. маслом 450 гр", unit:"шт", price:185 },
      { id:"p23", name:"Пельмени из филе грудки индейки со слив. маслом 900 гр", unit:"шт", price:370 },
      { id:"p24", name:"Подкоголи Домашние 450 гр", unit:"шт", price:175 },
      { id:"p25", name:"Подкоголи Домашние 900 гр", unit:"шт", price:350 },
      { id:"p26", name:"Равиоли 450г", unit:"шт", price:263 },
      { id:"p27", name:"Равиоли 900g", unit:"шт", price:525 },
      { id:"p28", name:"Фрикадельки Любимые 500 гр", unit:"шт", price:199 },
      { id:"p29", name:"Чебуреки по-домашнему 500 гр", unit:"шт", price:229 },
      { id:"p30", name:"Чебуреки с курицей 500 гр", unit:"шт", price:190 },
      { id:"p31", name:"Чебуреки с сыром 500 гр", unit:"шт", price:279 },
      { id:"p32", name:"Сырники 500 гр", unit:"шт", price:270 },

      // 6.2 Весовые (кг) — из фасовок
      { id:"w1",  name:"Вареники с картошкой вес.", unit:"кг", price:322 },
      { id:"w2",  name:"Голубцы ленивые вес.", unit:"кг", price:440 },
      { id:"w3",  name:"Зразы Любительские вес.", unit:"кг", price:450 },
      { id:"w4",  name:"Котлеты Домашние вес.", unit:"кг", price:530 },
      { id:"w5",  name:"Котлеты По-киевски вес.", unit:"кг", price:480 },
      { id:"w6",  name:"Котлеты Пожарские вес.", unit:"кг", price:460 },
      { id:"w7",  name:"Котлеты Фирменные вес.", unit:"кг", price:536 },
      { id:"w8",  name:"Котлеты из индейки вес.", unit:"кг", price:600 },
      { id:"w9",  name:"Котлеты куриные с сырно-сливочной начинкой вес.", unit:"кг", price:516 },
      { id:"w10", name:"Манты по-сибирски вес.", unit:"кг", price:411 },
      { id:"w11", name:"Наггетсы Фирменные вес.", unit:"кг", price:510 },
      { id:"w12", name:"Пельмени Домашние вес.", unit:"кг", price:398 },
      { id:"w13", name:"Пельмени Куриные вес.", unit:"кг", price:353 },
      { id:"w14", name:"Пельмени Свинина-Курица вес.", unit:"кг", price:356 },
      { id:"w15", name:"Пельмени из свинины вес.", unit:"кг", price:358 },
      { id:"w16", name:"Пельмени из филе грудки индейки со слив. маслом вес.", unit:"кг", price:411 },
      { id:"w17", name:"Подкоголи Домашние вес.", unit:"кг", price:389 },
      { id:"w18", name:"Равиоли вес.", unit:"кг", price:583 },
      { id:"w19", name:"Фрикадельки Любимые вес.", unit:"кг", price:398 },
      { id:"w20", name:"Чебуреки по-домашнему вес.", unit:"кг", price:458 },
      { id:"w21", name:"Чебуреки с курицей вес.", unit:"кг", price:380 },
      { id:"w22", name:"Чебуреки с сыром вес.", unit:"кг", price:558 },
      { id:"w23", name:"Сырники вес.", unit:"кг", price:540 },

      // 6.3 Весовые (кг) — изначально в прайсе
      { id:"wo1", name:"Голубцы с мясом и рисом вес.", unit:"кг", price:339 },
      { id:"wo2", name:"Колбаски Гриль с сыром вес.", unit:"кг", price:450 },
      { id:"wo3", name:"Колбаски куриные из филе грудки вес.", unit:"кг", price:416 },
      { id:"wo4", name:"Фарш Свинина-говядина вес.", unit:"кг", price:499 },
      { id:"wo5", name:"Фарш Свиной вес.", unit:"кг", price:395 }
    ];

    // ======================
    // STATE
    // ======================

    const state = {
      selectedManager: "",
      clientName: "",
      orderDate: new Date().toISOString().split("T")[0],
      orderComment: "",
      orderItems: [] // { id, productId, quantity }
    };

    // ======================
    // HELPERS
    // ======================

    const $ = (id) => document.getElementById(id);

    function showStatus(type, msg) {
      const alert = $("statusAlert");
      const icon = $("statusIcon");
      const text = $("statusText");

      alert.classList.remove("hidden", "bg-green-50", "border-green-100", "text-green-700", "bg-red-50", "border-red-100", "text-red-700");

      if (type === "success") {
        alert.classList.add("bg-green-50", "border-green-100", "text-green-700");
        icon.setAttribute("data-lucide", "check-circle-2");
      } else {
        alert.classList.add("bg-red-50", "border-red-100", "text-red-700");
        icon.setAttribute("data-lucide", "alert-circle");
      }

      text.textContent = msg;
      lucide.createIcons();

      setTimeout(() => alert.classList.add("hidden"), 2500);
    }

    function getProduct(id) {
      return PRODUCTS.find(p => p.id === id) || null;
    }

    function formatMoney(n) {
      const x = Math.round((Number(n) || 0) * 100) / 100;
      const s = x.toLocaleString("ru-RU", { maximumFractionDigits: 2 });
      return s.replace(/,00$/, "");
    }

    // Умная сортировка: внутри одной “базы” (без веса/граммов) — 450/500 → 900 → вес.
    function productSortKey(p) {
      const name = String(p.name || "");

      // базовое имя: убираем "вес.", "450", "500", "900", "гр", "г"
      const base = name
        .replace(/\bвес\.\b/gi, "")
        .replace(/\b\d+\s?(гр|г)\b/gi, "")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();

      // порядок размера
      let sizeRank = 50; // по умолчанию
      const m = name.match(/(\d+)\s?(гр|г)\b/i);
      if (m) {
        const grams = parseInt(m[1], 10);
        if (grams === 450 || grams === 440) sizeRank = 10;
        else if (grams === 500) sizeRank = 20;
        else if (grams === 900) sizeRank = 30;
        else sizeRank = 40;
      } else if (/вес\./i.test(name)) {
        sizeRank = 90; // весовые после фасовок
      }

      // сначала алфавит по базе, затем размер
      return { base, sizeRank, full: name.toLowerCase() };
    }

    function compareProducts(a, b) {
      const ka = productSortKey(a);
      const kb = productSortKey(b);

      const baseCmp = ka.base.localeCompare(kb.base, "ru");
      if (baseCmp !== 0) return baseCmp;

      if (ka.sizeRank !== kb.sizeRank) return ka.sizeRank - kb.sizeRank;

      return ka.full.localeCompare(kb.full, "ru");
    }

    function calculateTotal() {
      const total = state.orderItems.reduce((acc, item) => {
        const p = getProduct(item.productId);
        if (!p) return acc;
        return acc + (Number(item.quantity || 0) * p.price);
      }, 0);

      $("totalSum").textContent = formatMoney(total);
      const count = state.orderItems.filter(i => i.productId).length;
      $("itemsCount").textContent = `${count} ПОЗ.`;
    }

    // ======================
    // RENDER
    // ======================

    function renderManagers() {
      const sel = $("managerSelect");
      sel.innerHTML = `<option value="" disabled selected hidden>Выберите менеджера...</option>`;
      MANAGERS.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.name;
        opt.textContent = m.name;
        opt.className = "font-bold";
        sel.appendChild(opt);
      });
    }

    function renderItems() {
      const container = $("itemsContainer");
      container.innerHTML = "";

      state.orderItems.forEach(item => {
        const product = getProduct(item.productId);
        const sum = product ? (Number(item.quantity || 0) * product.price) : 0;

        const row = document.createElement("div");
        row.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-3 animate-fade-in";

        const sortedProducts = [...PRODUCTS].sort(compareProducts);

        row.innerHTML = `
          <div class="flex justify-between items-start gap-2">
            <div class="flex-1">
              <label class="text-[10px] text-slate-500 font-black uppercase mb-1 block tracking-wider">Товар</label>
              <select class="w-full text-sm font-black border-none focus:ring-0 p-0 bg-transparent cursor-pointer appearance-none ${!item.productId ? 'text-slate-400' : 'text-slate-950'}"
                      data-action="product" data-id="${item.id}">
                <option value="" disabled ${!item.productId ? 'selected' : ''} hidden>Выберите товар...</option>
                ${sortedProducts.map(p => `
                  <option value="${p.id}" ${item.productId === p.id ? 'selected' : ''} class="text-slate-950 font-bold">${p.name}</option>
                `).join("")}
              </select>
            </div>
            <button class="text-slate-300 hover:text-red-500 p-1 transition-colors"
                    data-action="remove" data-id="${item.id}" title="Удалить">
              <i data-lucide="trash-2" class="w-4.5 h-4.5"></i>
            </button>
          </div>

          <div class="grid grid-cols-3 gap-4 border-t border-slate-50 pt-3">
            <div>
              <label class="text-[9px] text-slate-500 font-black uppercase mb-1 block">Цена</label>
              <div class="text-[13px] font-bold text-slate-600">${product ? `${product.price}₽ / ${product.unit}` : "—"}</div>
            </div>
            <div>
              <label class="text-[9px] text-slate-500 font-black uppercase mb-1 block">Кол-во</label>
              <input type="number"
                     ${!item.productId ? 'disabled' : ''}
                     step="any"
                     inputmode="decimal"
                     value="${item.quantity || ''}"
                     placeholder="0"
                     data-action="qty" data-id="${item.id}"
                     class="w-full text-sm font-black bg-slate-50 disabled:bg-slate-100 disabled:opacity-50 rounded-lg px-2 py-1 border border-slate-200 focus:outline-none focus:border-green-500 text-slate-950">
            </div>
            <div class="text-right">
              <label class="text-[9px] text-slate-500 font-black uppercase mb-1 block">Сумма</label>
              <div class="text-[13px] font-black text-green-700">${formatMoney(sum)} ₽</div>
            </div>
          </div>
        `;

        container.appendChild(row);
      });

      calculateTotal();
      lucide.createIcons();
    }

    // ======================
    // ACTIONS
    // ======================

    function addRow() {
      state.orderItems.push({
        id: Math.random().toString(36).slice(2, 11),
        productId: "",
        quantity: 0
      });
      renderItems();
    }

    function removeRow(id) {
      state.orderItems = state.orderItems.filter(i => i.id !== id);
      renderItems();
    }

    function updateItemProduct(id, productId) {
      const item = state.orderItems.find(i => i.id === id);
      if (!item) return;

      item.productId = productId;
      const p = getProduct(productId);
      item.quantity = (p && p.unit === "кг") ? 1.0 : 1;

      renderItems();
    }

    function updateItemQty(id, qtyRaw) {
      const item = state.orderItems.find(i => i.id === id);
      if (!item) return;

      const p = getProduct(item.productId);
      let q = Number(qtyRaw);
      if (!isFinite(q) || q < 0) q = 0;

      // шт — целое, кг — до 2 знаков
      if (p && p.unit === "шт") q = Math.trunc(q);
      else q = Math.round(q * 100) / 100;

      item.quantity = q;

      // без полного rerender можно, но тут проще/надёжнее — renderItems()
      renderItems();
    }

    function generateMessageText() {
      const dateFormatted = new Date(state.orderDate).toLocaleDateString("ru-RU");

      let text = `ЗАЯВКА\n${(state.clientName || "").trim() || "Клиент не указан"}\n\n`;
      text += `Менеджер: ${state.selectedManager || "Не выбран"}\n`;
      text += `Дата: ${dateFormatted}\n\n`;

      const validItems = state.orderItems.filter(i => i.productId);
      if (validItems.length > 0) {
        text += `Список позиций:\n`;
        validItems.forEach((item, index) => {
          const p = getProduct(item.productId);
          if (!p) return;
          const sum = Number(item.quantity || 0) * p.price;
          text += `${index + 1}) ${p.name} — ${item.quantity} ${p.unit} × ${p.price} ₽ = ${formatMoney(sum)} ₽\n`;
        });
      }

      if ((state.orderComment || "").trim()) {
        text += `\nКомментарий: ${(state.orderComment || "").trim()}\n`;
      }

      const total = validItems.reduce((acc, item) => {
        const p = getProduct(item.productId);
        if (!p) return acc;
        return acc + (Number(item.quantity || 0) * p.price);
      }, 0);

      text += `\nИтого: ${formatMoney(total)} ₽`;

      return text;
    }

    async function copyToClipboard() {
      const text = generateMessageText();
      try {
        await navigator.clipboard.writeText(text);
        showStatus("success", "Текст скопирован");
      } catch (e) {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showStatus("success", "Текст скопирован");
      }
    }

    function sendToTelegram() {
      if (!state.selectedManager) {
        showStatus("error", "Выберите менеджера");
        return;
      }
      const hasItems = state.orderItems.some(i => i.productId);
      if (!hasItems) {
        showStatus("error", "Добавьте товары в заявку");
        return;
      }

      const text = generateMessageText();
      const encodedText = encodeURIComponent(text);

      // Это откроет экран “Поделиться…” (как у тебя на 2-м скрине), если Telegram установлен
      window.open(`https://t.me/share/url?url=&text=${encodedText}`, "_blank");
    }

    function resetForm() {
      if (!confirm("Очистить форму заявки?")) return;

      state.selectedManager = "";
      state.clientName = "";
      state.orderDate = new Date().toISOString().split("T")[0];
      state.orderComment = "";
      state.orderItems = [];

      $("managerSelect").value = "";
      $("managerSelect").classList.add("text-slate-400");
      $("managerSelect").classList.remove("text-slate-950");
      $("clientInput").value = "";
      $("dateInput").value = state.orderDate;
      $("commentInput").value = "";

      renderItems();
    }

    // ======================
    // INIT
    // ======================

    function init() {
      renderManagers();

      $("dateInput").value = state.orderDate;

      $("managerSelect").addEventListener("change", (e) => {
        state.selectedManager = e.target.value || "";
        if (state.selectedManager) {
          $("managerSelect").classList.remove("text-slate-400");
          $("managerSelect").classList.add("text-slate-950");
        }
      });

      $("clientInput").addEventListener("input", (e) => state.clientName = e.target.value);
      $("dateInput").addEventListener("change", (e) => state.orderDate = e.target.value);
      $("commentInput").addEventListener("input", (e) => state.orderComment = e.target.value);

      $("addRowBtn").addEventListener("click", addRow);

      $("itemsContainer").addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        if (action === "remove") removeRow(id);
      });

      $("itemsContainer").addEventListener("change", (e) => {
        const el = e.target;
        const action = el.getAttribute("data-action");
        const id = el.getAttribute("data-id");
        if (!action || !id) return;

        if (action === "product") updateItemProduct(id, el.value);
      });

      $("itemsContainer").addEventListener("input", (e) => {
        const el = e.target;
        const action = el.getAttribute("data-action");
        const id = el.getAttribute("data-id");
        if (!action || !id) return;

        if (action === "qty") updateItemQty(id, el.value);
      });

      $("copyBtn").addEventListener("click", copyToClipboard);
      $("sendBtn").addEventListener("click", sendToTelegram);
      $("resetBtn").addEventListener("click", resetForm);

      // старт: пусто (как на скрине), чтобы не было “лишней” позиции
      renderItems();

      lucide.createIcons();
    }

    init();
  </script>
</body>
</html>
